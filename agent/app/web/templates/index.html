<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rMirror Agent</title>
    <style>
        /* rMirror Design System - CSS Variables */
        :root {
            /* Color Palette - Warm, sophisticated palette inspired by Moleskine */
            --warm-charcoal: #2d2a2e;
            --soft-cream: #faf8f5;
            --terracotta: #c85a54;
            --warm-gray: #8b8680;
            --amber-gold: #d4a574;
            --sage-green: #7a9c89;

            /* Semantic Design Tokens */
            --background: #faf8f5;
            --foreground: #2d2a2e;
            --card: #ffffff;
            --card-foreground: #2d2a2e;
            --primary: #c85a54;
            --primary-foreground: #ffffff;
            --secondary: #d4a574;
            --secondary-foreground: #2d2a2e;
            --muted: #faf8f5;
            --muted-foreground: #8b8680;
            --accent: #c85a54;
            --success: #7a9c89;
            --success-foreground: #ffffff;
            --destructive: #dc2626;
            --destructive-foreground: #ffffff;
            --border: #e8e4df;
            --input: #e8e4df;
            --ring: #c85a54;

            /* Border Radius */
            --radius-sm: 6px;
            --radius: 8px;
            --radius-lg: 12px;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(45, 42, 46, 0.06);
            --shadow-md: 0 4px 12px rgba(45, 42, 46, 0.08);
            --shadow-lg: 0 8px 20px rgba(45, 42, 46, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--foreground);
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Subtle paper texture for backgrounds */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' /%3E%3C/svg%3E");
            z-index: -1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        header {
            margin-bottom: 24px;
        }

        h1 {
            font-size: 2.5em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--warm-charcoal);
        }

        h2 {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--warm-charcoal);
        }

        h3 {
            font-size: 1.25em;
            font-weight: 600;
            color: var(--warm-charcoal);
        }

        .subtitle {
            color: var(--warm-gray);
            font-size: 1.05em;
            line-height: 1.5;
        }

        /* Elastic band divider (Moleskine-inspired) */
        .elastic-divider {
            position: relative;
            width: 100%;
            height: 1px;
            margin: 24px 0;
        }

        .elastic-divider::before {
            content: "";
            position: absolute;
            inset: 0;
            background: var(--border);
        }

        .elastic-divider::after {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            width: 64px;
            height: 100%;
            background: var(--terracotta);
            opacity: 0.3;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .card h2 {
            margin-bottom: 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-label {
            color: var(--warm-gray);
            font-size: 0.875em;
            font-weight: 500;
        }

        .status-value {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875em;
            font-weight: 500;
            color: var(--foreground);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-indicator.green {
            background: var(--sage-green);
        }

        .status-indicator.red {
            background: var(--destructive);
        }

        .status-indicator.yellow {
            background: var(--amber-gold);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--foreground);
            font-size: 0.925em;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.925em;
            font-family: inherit;
            background: var(--card);
            color: var(--foreground);
            transition: all 0.15s;
        }

        input:focus {
            outline: none;
            border-color: var(--ring);
            box-shadow: 0 0 0 3px rgba(200, 90, 84, 0.1);
        }

        button {
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-size: 0.925em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: #b34e49;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(200, 90, 84, 0.2);
        }

        button:active {
            background: #a3443f;
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
        }

        button.secondary:hover {
            background: #c9995d;
        }

        button.secondary:active {
            background: #b88d52;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .alert {
            padding: 14px 16px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 0.925em;
            border: 1px solid;
        }

        .alert.success {
            background: rgba(122, 156, 137, 0.1);
            color: var(--sage-green);
            border-color: var(--sage-green);
        }

        .alert.error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--destructive);
            border-color: var(--destructive);
        }

        .alert.info {
            background: rgba(200, 90, 84, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        #message {
            display: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header h2 {
            margin-bottom: 0;
        }

        .settings-button {
            background: transparent;
            color: var(--warm-gray);
            border: 1px solid var(--border);
            padding: 8px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            font-weight: 500;
        }

        .settings-button:hover {
            background: var(--soft-cream);
            border-color: var(--warm-gray);
            color: var(--warm-charcoal);
            transform: translateY(-1px);
        }

        .settings-button:active {
            transform: translateY(0);
        }

        .sign-in-button {
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(200, 90, 84, 0.2);
            transition: all 0.15s;
            font-weight: 500;
            margin-right: 8px;
        }

        .sign-in-button:hover {
            background: #b34e49;
            box-shadow: 0 3px 6px rgba(200, 90, 84, 0.3);
            transform: translateY(-1px);
        }

        .sign-in-button:active {
            background: #a3443f;
            box-shadow: 0 1px 2px rgba(200, 90, 84, 0.2);
            transform: translateY(0);
        }

        .settings-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 42, 46, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .settings-overlay.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .settings-content {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 600px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            position: relative;
            border: 1px solid var(--border);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .settings-header h2 {
            margin: 0;
        }

        .close-button {
            background: transparent;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--warm-gray);
            border-radius: 50%;
            transition: all 0.15s;
        }

        .close-button:hover {
            color: var(--warm-charcoal);
            background: var(--soft-cream);
        }

        .notebook-table-header {
            display: grid;
            grid-template-columns: 30px 1fr 150px 80px;
            gap: 12px;
            padding: 10px 12px;
            background: var(--soft-cream);
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.8em;
            color: var(--warm-gray);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .notebook-row {
            display: grid;
            grid-template-columns: 30px 1fr 150px 80px;
            gap: 12px;
            padding: 10px 12px;
            align-items: center;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
        }

        .notebook-row:hover {
            background: var(--soft-cream);
        }

        .notebook-row:hover .notebook-name {
            color: var(--terracotta);
        }

        .notebook-name {
            font-weight: 500;
            color: var(--warm-charcoal);
            font-size: 0.875em;
            transition: color 0.15s;
        }

        .notebook-date {
            font-size: 0.8em;
            color: var(--warm-gray);
        }

        .notebook-pages {
            font-size: 0.8em;
            color: var(--warm-gray);
            text-align: right;
        }

        /* Date group styles */
        .date-group {
            margin-bottom: 20px;
        }

        .date-group-header {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--warm-gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            padding: 0 12px;
        }

        /* Settings modal section headers */
        .settings-content h3 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-size: 1.1em;
        }

        .settings-content h3:first-of-type {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>rMirror Agent</h1>
            <p class="subtitle">Seamless cloud sync for your reMarkable notebooks</p>
        </header>

        <!-- Elastic band divider -->
        <div class="elastic-divider"></div>

        <div id="message" class="alert"></div>

        <!-- Status Card -->
        <div class="card">
            <div class="card-header">
                <h2>Status</h2>
                <div style="display: flex; align-items: center;">
                    <button class="sign-in-button" id="sign-in-btn" onclick="openAuth()" style="display: none;">
                        Sign In
                    </button>
                    <button class="settings-button" onclick="openSettings()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                        </svg>
                        Settings
                    </button>
                </div>
            </div>
            <div class="status-grid" style="grid-template-columns: repeat(5, 1fr);">
                <div class="status-item">
                    <div class="status-label">Agent</div>
                    <div class="status-value">
                        <span class="status-indicator green"></span>
                        Running
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Authentication</div>
                    <div class="status-value" id="auth-status">
                        <span class="status-indicator yellow"></span>
                        Checking...
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Monthly Quota</div>
                    <div class="status-value" id="quota-status">
                        <span class="status-indicator yellow"></span>
                        Loading...
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">File Watching</div>
                    <div class="status-value" id="watch-status">
                        <span class="status-indicator green"></span>
                        {{ 'Enabled' if config.remarkable.watch_enabled else 'Disabled' }}
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Auto Sync</div>
                    <div class="status-value" id="sync-status">
                        <span class="status-indicator green"></span>
                        {{ 'Enabled' if config.sync.auto_sync else 'Disabled' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Quota Warning Card (shown when quota >= 80%) -->
        <div class="alert" id="quota-warning-card" style="display: none; padding: 20px; margin-bottom: 24px; position: relative;">
            <div style="display: flex; align-items: start; gap: 12px;">
                <div id="quota-warning-icon" style="font-size: 24px; margin-top: 2px;">‚ö†Ô∏è</div>
                <div style="flex: 1;">
                    <h3 id="quota-warning-title" style="margin: 0 0 8px 0; font-size: 1.1em; font-weight: 600; color: var(--warm-charcoal);"></h3>
                    <p id="quota-warning-text" style="margin: 0 0 16px 0; font-size: 0.925em; color: var(--warm-gray); line-height: 1.5;"></p>
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <a href="https://rmirror.io/billing" target="_blank" class="button" id="quota-upgrade-btn" style="text-decoration: none; padding: 10px 20px; border-radius: var(--radius); font-size: 0.925em; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: var(--primary-foreground);">
                            View Upgrade Options
                        </a>
                        <a href="https://rmirror.io/billing" target="_blank" style="font-size: 0.925em; color: var(--terracotta); text-decoration: underline;">
                            View quota details
                        </a>
                    </div>
                </div>
                <button onclick="dismissQuotaWarning()" style="background: transparent; border: none; font-size: 1.5em; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: var(--warm-gray); border-radius: 50%; transition: all 0.15s;" onmouseover="this.style.background='var(--soft-cream)'" onmouseout="this.style.background='transparent'">
                    √ó
                </button>
            </div>
        </div>

        <!-- Notebook Selection Card -->
        <div class="card">
            <h2>Notebook Selection</h2>
            <p style="color: #666; margin-bottom: 20px;">Choose which notebooks to sync to stay within your plan limits.</p>

            <div class="status-grid" style="margin-bottom: 20px;">
                <div class="status-item">
                    <div class="status-label">Total Pages</div>
                    <div class="status-value" id="total-pages">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Selected Pages</div>
                    <div class="status-value" id="selected-pages">-</div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="sync-all" style="margin-right: 10px;">
                    <span>Sync all notebooks</span>
                </label>
            </div>

            <div id="notebook-tree" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                <div style="text-align: center; padding: 20px; color: #999;">
                    Loading notebooks...
                </div>
            </div>

            <div class="button-group" style="margin-top: 15px;">
                <button onclick="saveNotebookSelection()">Save Selection</button>
                <button class="secondary" onclick="loadNotebookTree()">Refresh</button>
            </div>
        </div>

        <!-- Actions Card -->
        <div class="card">
            <h2>Actions</h2>
            <p style="color: var(--warm-gray); margin-bottom: 20px; font-size: 0.925em;">
                <strong>Initial Sync:</strong> Upload all pages and content for your selected notebooks. Use this for first-time setup or to catch up after being offline. Respects your notebook selection above.
            </p>
            <div class="button-group">
                <button onclick="triggerInitialSync()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Initial Sync
                </button>
                <button class="secondary" onclick="triggerSync()">Sync Now</button>
                <button class="secondary" onclick="refreshStatus()">Refresh Status</button>
            </div>
        </div>
    </div>

    <!-- Settings Overlay (Modal) -->
    <div class="settings-overlay" id="settings-overlay" onclick="closeSettingsIfClickedOutside(event)">
        <div class="settings-content" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2>Account Settings</h2>
                <button class="close-button" onclick="closeSettings()">&times;</button>
            </div>

            <form id="config-form">
                <h3 style="margin-bottom: 15px; font-size: 1.2em;">API Settings</h3>

                <div class="form-group">
                    <label for="api-url">API URL</label>
                    <input type="text" id="api-url" name="api_url" value="{{ api_url }}" required>
                </div>

                {% if not use_clerk_auth %}
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="{{ email }}" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter to update">
                </div>
                {% endif %}

                <h3 style="margin: 30px 0 15px; font-size: 1.2em;">reMarkable Settings</h3>

                <div class="form-group">
                    <label for="remarkable-dir">Sync Directory</label>
                    <input type="text" id="remarkable-dir" name="remarkable_dir" value="{{ remarkable_dir }}" required>
                </div>

                <h3 style="margin: 30px 0 15px; font-size: 1.2em;">Sync Settings</h3>

                <div class="checkbox-group">
                    <input type="checkbox" id="auto-sync" name="auto_sync" {{ 'checked' if auto_sync else '' }}>
                    <label for="auto-sync" style="margin: 0;">Enable automatic syncing</label>
                </div>

                <div class="button-group">
                    <button type="submit">Save Configuration</button>
                    <button type="button" class="secondary" onclick="testConnection()">Test Connection</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Auth Overlay (Modal) -->
    <div class="settings-overlay" id="auth-overlay" onclick="closeAuthIfClickedOutside(event)">
        <div class="settings-content" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2>Sign In</h2>
                <button class="close-button" onclick="closeAuth()">&times;</button>
            </div>

            {% if use_clerk_auth %}
            <!-- Clerk Authentication -->
            <div style="text-align: center; padding: 20px 0;">
                <p style="margin-bottom: 30px; color: #666; font-size: 1.05em;">
                    Sign in with your rMirror account to start syncing your notebooks to the cloud.
                </p>
                <button onclick="openAuthPage()" style="background: #667eea; font-size: 1.1em; padding: 14px 28px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
            {% else %}
            <!-- Password Authentication -->
            <form id="auth-form" onsubmit="handlePasswordAuth(event)">
                <div class="form-group">
                    <label for="auth-email">Email</label>
                    <input type="email" id="auth-email" name="email" required autofocus>
                </div>

                <div class="form-group">
                    <label for="auth-password">Password</label>
                    <input type="password" id="auth-password" name="password" required>
                </div>

                <div class="button-group">
                    <button type="submit">Sign In</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <script>
        // Auth modal functions
        function openAuth() {
            document.getElementById('auth-overlay').classList.add('active');
        }

        function closeAuth() {
            document.getElementById('auth-overlay').classList.remove('active');
        }

        function closeAuthIfClickedOutside(event) {
            if (event.target.id === 'auth-overlay') {
                closeAuth();
            }
        }

        async function handlePasswordAuth(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: formData.get('email'),
                        password: formData.get('password'),
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Successfully authenticated!', 'success');
                    closeAuth();
                    refreshStatus();
                } else {
                    showMessage(data.message || 'Authentication failed', 'error');
                }
            } catch (error) {
                showMessage('Authentication failed: ' + error.message, 'error');
            }
        }

        // Settings modal functions
        function openSettings() {
            document.getElementById('settings-overlay').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settings-overlay').classList.remove('active');
        }

        function closeSettingsIfClickedOutside(event) {
            if (event.target.id === 'settings-overlay') {
                closeSettings();
            }
        }

        // Show message
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `alert ${type}`;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // Open authentication page
        function openAuthPage() {
            fetch('/api/auth/status')
                .then(res => res.json())
                .then(data => {
                    const authUrl = data.clerk_frontend_api + '/agent';
                    window.open(authUrl, '_blank', 'width=500,height=700');
                })
                .catch(error => {
                    showMessage('Failed to open authentication page', 'error');
                });
        }

        // Test connection
        async function testConnection() {
            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Connection test failed: ' + error.message, 'error');
            }
        }

        // Trigger initial sync
        async function triggerInitialSync() {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;

            try {
                // Disable button and show loading state
                button.disabled = true;
                button.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 2v4"/>
                    </svg>
                    Syncing...
                `;

                const response = await fetch('/api/sync/initial', {
                    method: 'POST',
                });

                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;
                    const message = `Initial sync complete! Synced ${stats.notebooks} notebook(s) with ${stats.pages} page(s).`;
                    showMessage(message, 'success');

                    // Refresh status after sync
                    await refreshStatus();
                } else {
                    showMessage(data.message || 'Initial sync failed', 'error');
                }
            } catch (error) {
                showMessage('Initial sync failed: ' + error.message, 'error');
            } finally {
                // Re-enable button
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Add spinning animation for loading state
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Trigger sync
        async function triggerSync() {
            try {
                const response = await fetch('/api/sync/trigger', {
                    method: 'POST',
                });

                const data = await response.json();
                showMessage(data.message, 'success');
            } catch (error) {
                showMessage('Sync trigger failed: ' + error.message, 'error');
            }
        }

        // Refresh status
        async function refreshStatus() {
            try {
                const [statusRes, authRes] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/auth/status')
                ]);

                const statusData = await statusRes.json();
                const authData = await authRes.json();

                // Update authentication status
                const authStatus = document.getElementById('auth-status');
                const signInBtn = document.getElementById('sign-in-btn');

                const isAuthenticated = statusData.authentication.authenticated || authData.authenticated;

                if (isAuthenticated) {
                    authStatus.innerHTML = '<span class="status-indicator green"></span>Authenticated';
                    signInBtn.style.display = 'none'; // Hide sign-in button

                    // Fetch quota status when authenticated
                    await refreshQuotaStatus();
                } else {
                    authStatus.innerHTML = '<span class="status-indicator red"></span>Not Authenticated';
                    signInBtn.style.display = 'flex'; // Show sign-in button

                    // Clear quota display when not authenticated
                    const quotaStatus = document.getElementById('quota-status');
                    quotaStatus.innerHTML = '<span class="status-indicator yellow"></span>Not Available';
                }

                showMessage('Status refreshed', 'success');
            } catch (error) {
                showMessage('Status refresh failed: ' + error.message, 'error');
            }
        }

        // Dismiss quota warning
        function dismissQuotaWarning() {
            const card = document.getElementById('quota-warning-card');
            card.style.display = 'none';
            // Store dismissal in localStorage with current quota percentage
            const quota = JSON.parse(localStorage.getItem('current_quota') || '{}');
            localStorage.setItem('quota_warning_dismissed', quota.percentage_used || '0');
        }

        // Refresh quota status
        async function refreshQuotaStatus() {
            try {
                const response = await fetch('/api/quota');

                if (!response.ok) {
                    throw new Error('Failed to fetch quota');
                }

                const quota = await response.json();
                const quotaStatus = document.getElementById('quota-status');

                // Store current quota for dismissal tracking
                localStorage.setItem('current_quota', JSON.stringify(quota));

                // Determine color based on usage
                let indicatorClass = 'green';
                if (quota.is_exhausted) {
                    indicatorClass = 'red';
                } else if (quota.is_near_limit) {
                    indicatorClass = 'yellow';
                }

                // Format display
                const percentage = Math.round(quota.percentage_used);
                quotaStatus.innerHTML = `<span class="status-indicator ${indicatorClass}"></span>${quota.used}/${quota.limit} (${percentage}%)`;

                // Show quota warning card if >= 80% and not dismissed at this percentage
                const dismissedAt = parseFloat(localStorage.getItem('quota_warning_dismissed') || '0');
                const shouldShow = quota.percentage_used >= 80 && quota.percentage_used > dismissedAt;

                if (shouldShow) {
                    updateQuotaWarningCard(quota);
                } else {
                    document.getElementById('quota-warning-card').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to fetch quota:', error);
                const quotaStatus = document.getElementById('quota-status');
                quotaStatus.innerHTML = '<span class="status-indicator yellow"></span>Error';
            }
        }

        // Update quota warning card content
        function updateQuotaWarningCard(quota) {
            const card = document.getElementById('quota-warning-card');
            const icon = document.getElementById('quota-warning-icon');
            const title = document.getElementById('quota-warning-title');
            const text = document.getElementById('quota-warning-text');
            const upgradeBtn = document.getElementById('quota-upgrade-btn');

            const percentage = Math.round(quota.percentage_used);
            const remaining = quota.limit - quota.used;
            const isExhausted = quota.is_exhausted;

            // Update card styling based on status
            if (isExhausted) {
                // Red styling for exhausted
                card.style.backgroundColor = 'rgba(200, 90, 84, 0.1)';
                card.style.borderColor = 'var(--destructive)';
                card.style.borderWidth = '1px';
                card.style.borderStyle = 'solid';
                icon.textContent = 'üî¥';
                title.textContent = 'Free Tier Quota Exhausted';
                upgradeBtn.textContent = 'View Upgrade Options';
            } else {
                // Yellow styling for approaching limit
                card.style.backgroundColor = 'rgba(212, 165, 116, 0.1)';
                card.style.borderColor = 'var(--amber-gold)';
                card.style.borderWidth = '1px';
                card.style.borderStyle = 'solid';
                icon.textContent = '‚ö†Ô∏è';
                title.textContent = 'Approaching Quota Limit';
                upgradeBtn.textContent = 'Upgrade to Pro';
            }

            // Update text content
            if (isExhausted) {
                const resetDate = new Date(quota.reset_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                text.innerHTML = `You've used all ${quota.limit} free pages this month. Your notebooks will continue syncing, but OCR transcription and integrations are paused until your quota resets on <strong>${resetDate}</strong>.`;
            } else {
                text.innerHTML = `You've used ${quota.used} of ${quota.limit} free pages (${percentage}%). Only ${remaining} page${remaining !== 1 ? 's' : ''} remaining this month.`;
            }

            // Show the card
            card.style.display = 'block';
        }

        // Handle form submission
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const config = {
                api: {
                    url: formData.get('api_url'),
                    email: formData.get('email'),
                },
                remarkable: {
                    source_directory: formData.get('remarkable_dir'),
                },
                sync: {
                    auto_sync: formData.get('auto_sync') === 'on',
                },
            };

            // Include password if provided
            const password = formData.get('password');
            if (password) {
                config.api.password = password;
            }

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config),
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message, 'success');
                    // Clear password field
                    document.getElementById('password').value = '';
                    // Close settings modal
                    closeSettings();
                } else {
                    showMessage('Configuration save failed', 'error');
                }
            } catch (error) {
                showMessage('Configuration save failed: ' + error.message, 'error');
            }
        });

        // Notebook selection state
        let selectedNotebooks = new Set();
        let syncAll = true;
        let notebookTree = [];

        // Load notebook tree
        async function loadNotebookTree() {
            try {
                const response = await fetch('/api/notebooks/tree');
                const data = await response.json();

                if (data.error) {
                    showMessage('Failed to load notebooks: ' + data.error, 'error');
                    return;
                }

                notebookTree = data.tree;

                // Debug: log tree structure
                console.log('Loaded tree:', data.tree);
                console.log('Root items:', data.tree.length);

                // Update stats
                document.getElementById('total-pages').textContent = data.stats.total_pages || '0';
                document.getElementById('selected-pages').textContent = data.stats.selected_pages || '0';

                // Render tree
                renderNotebookTree(data.tree);

                // Load current selection
                await loadNotebookSelection();
            } catch (error) {
                showMessage('Failed to load notebooks: ' + error.message, 'error');
            }
        }

        // Load current selection
        async function loadNotebookSelection() {
            try {
                const response = await fetch('/api/notebooks/selection');
                const data = await response.json();

                syncAll = data.sync_all_notebooks;
                selectedNotebooks = new Set(data.selected_notebooks || []);

                // Update checkbox
                document.getElementById('sync-all').checked = syncAll;

                // Update tree checkboxes
                updateTreeCheckboxes();
            } catch (error) {
                console.error('Failed to load selection:', error);
            }
        }

        // Render notebook groups by date
        function renderNotebookTree(groups) {
            const container = document.getElementById('notebook-tree');
            container.innerHTML = '';

            console.log('Rendering date groups:', groups.length);

            groups.forEach(dateGroup => {
                // Create group container
                const groupDiv = document.createElement('div');
                groupDiv.style.marginBottom = '12px';

                // Create group header
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.alignItems = 'center';
                header.style.padding = '8px';
                header.style.cursor = 'pointer';
                header.style.borderRadius = '4px';
                header.style.backgroundColor = '#f5f5f5';
                header.style.fontWeight = 'bold';

                // Hover effect
                header.addEventListener('mouseenter', () => {
                    header.style.backgroundColor = '#e8e8e8';
                });
                header.addEventListener('mouseleave', () => {
                    header.style.backgroundColor = '#f5f5f5';
                });

                // Arrow for expand/collapse
                const arrow = document.createElement('span');
                arrow.textContent = '‚ñ∂';
                arrow.style.marginRight = '8px';
                arrow.style.fontSize = '12px';
                arrow.style.transition = 'transform 0.2s';
                arrow.style.transform = 'rotate(90deg)'; // Start expanded
                arrow.id = 'arrow-' + dateGroup.group;
                header.appendChild(arrow);

                // Group checkbox (to select all in group)
                const groupCheckbox = document.createElement('input');
                groupCheckbox.type = 'checkbox';
                groupCheckbox.disabled = syncAll;
                groupCheckbox.style.marginRight = '8px';
                groupCheckbox.checked = isGroupSelected(dateGroup.notebooks);
                groupCheckbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    toggleGroup(dateGroup.notebooks, groupCheckbox.checked);
                });
                header.appendChild(groupCheckbox);

                // Group label
                const label = document.createElement('span');
                label.textContent = `${dateGroup.group} (${dateGroup.notebooks.length})`;
                header.appendChild(label);

                // Click to expand/collapse
                header.addEventListener('click', (e) => {
                    if (e.target !== groupCheckbox) {
                        const notebooksDiv = document.getElementById('notebooks-' + dateGroup.group);
                        const isExpanded = notebooksDiv.style.display !== 'none';
                        notebooksDiv.style.display = isExpanded ? 'none' : 'block';
                        arrow.style.transform = isExpanded ? '' : 'rotate(90deg)';
                    }
                });

                groupDiv.appendChild(header);

                // Create notebooks container
                const notebooksDiv = document.createElement('div');
                notebooksDiv.id = 'notebooks-' + dateGroup.group;
                notebooksDiv.style.display = 'block'; // Start expanded
                notebooksDiv.style.marginLeft = '20px';
                notebooksDiv.style.marginTop = '4px';

                // Add table header
                const tableHeader = document.createElement('div');
                tableHeader.className = 'notebook-table-header';
                tableHeader.innerHTML = `
                    <div></div>
                    <div>Name</div>
                    <div>Last Opened</div>
                    <div style="text-align: right;">Pages</div>
                `;
                notebooksDiv.appendChild(tableHeader);

                // Render each notebook
                dateGroup.notebooks.forEach(notebook => {
                    const row = document.createElement('div');
                    row.className = 'notebook-row';

                    // Checkbox
                    const checkboxCell = document.createElement('div');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = 'nb-' + notebook.uuid;
                    checkbox.checked = syncAll || selectedNotebooks.has(notebook.uuid);
                    checkbox.disabled = syncAll;
                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        toggleNotebook(notebook.uuid);
                    });
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);

                    // Name
                    const nameCell = document.createElement('div');
                    nameCell.className = 'notebook-name';
                    nameCell.textContent = notebook.name;
                    row.appendChild(nameCell);

                    // Date
                    const dateCell = document.createElement('div');
                    dateCell.className = 'notebook-date';
                    const lastOpenedDate = new Date(notebook.lastOpened);
                    dateCell.textContent = lastOpenedDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    row.appendChild(dateCell);

                    // Pages
                    const pagesCell = document.createElement('div');
                    pagesCell.className = 'notebook-pages';
                    pagesCell.textContent = notebook.pageCount || 0;
                    row.appendChild(pagesCell);

                    // Click row to toggle checkbox
                    row.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                            toggleNotebook(notebook.uuid);
                        }
                    });

                    notebooksDiv.appendChild(row);
                });

                groupDiv.appendChild(notebooksDiv);
                container.appendChild(groupDiv);
            });
        }

        // Check if all notebooks in a group are selected
        function isGroupSelected(notebooks) {
            return notebooks.every(nb => selectedNotebooks.has(nb.uuid));
        }

        // Toggle all notebooks in a group
        function toggleGroup(notebooks, checked) {
            notebooks.forEach(notebook => {
                if (checked) {
                    selectedNotebooks.add(notebook.uuid);
                } else {
                    selectedNotebooks.delete(notebook.uuid);
                }
                const checkbox = document.getElementById('nb-' + notebook.uuid);
                if (checkbox) {
                    checkbox.checked = checked;
                }
            });
            updateSelectedPagesCount();
        }

        // Update tree checkboxes based on sync mode
        function updateTreeCheckboxes() {
            const checkboxes = document.querySelectorAll('#notebook-tree input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.disabled = syncAll;
                if (syncAll) {
                    cb.checked = true;
                } else {
                    const uuid = cb.id.replace('nb-', '');
                    cb.checked = selectedNotebooks.has(uuid);
                }
            });
        }

        // Toggle notebook selection
        function toggleNotebook(uuid) {
            if (selectedNotebooks.has(uuid)) {
                selectedNotebooks.delete(uuid);
            } else {
                selectedNotebooks.add(uuid);
            }
            updateSelectedPagesCount();
        }

        // Update selected pages count
        async function updateSelectedPagesCount() {
            if (syncAll) {
                const response = await fetch('/api/notebooks/tree');
                const data = await response.json();
                document.getElementById('selected-pages').textContent = data.stats.total_pages || '0';
            } else {
                // Calculate from selected notebooks
                let totalPages = 0;
                notebookTree.forEach(group => {
                    group.notebooks.forEach(notebook => {
                        if (selectedNotebooks.has(notebook.uuid) && notebook.pageCount) {
                            totalPages += notebook.pageCount;
                        }
                    });
                });
                document.getElementById('selected-pages').textContent = totalPages;
            }
        }

        // Save notebook selection
        async function saveNotebookSelection() {
            try {
                const response = await fetch('/api/notebooks/selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sync_all_notebooks: syncAll,
                        selected_notebooks: Array.from(selectedNotebooks),
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message, 'success');
                    await loadNotebookTree(); // Refresh to show updated stats
                } else {
                    showMessage('Failed to save selection', 'error');
                }
            } catch (error) {
                showMessage('Failed to save selection: ' + error.message, 'error');
            }
        }

        // Sync all checkbox handler
        document.getElementById('sync-all').addEventListener('change', (e) => {
            syncAll = e.target.checked;
            updateTreeCheckboxes();
            updateSelectedPagesCount();
        });

        // Refresh status on load
        refreshStatus();
        loadNotebookTree();
    </script>
</body>
</html>
