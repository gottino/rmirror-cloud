# nginx rate limiting configuration for rMirror
#
# DEPLOYMENT INSTRUCTIONS:
# 1. SSH to server: ssh deploy@167.235.74.51
# 2. Edit nginx.conf: sudo nano /etc/nginx/nginx.conf
# 3. Replace the limit_req_zone lines with these (in http block):

limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=300r/m;

# NOTE: Removed api_limit zone - rate limiting for API is now handled
# at the FastAPI application level, with user-aware limits:
# - Authenticated users: 300/minute (by user ID)
# - Unauthenticated: 30/minute (by IP)
# This prevents logged-in users from hitting rate limits during normal use.

# 4. Edit site config: sudo nano /etc/nginx/sites-available/rmirror
# 5. Update the location blocks:

# REMOVE rate limiting from /v1/ (FastAPI handles it now):
#
# location /v1/ {
#     # NO limit_req here - FastAPI handles user-aware rate limiting
#     proxy_pass http://127.0.0.1:8000/v1/;
#     ...
# }

# KEEP rate limiting only on dashboard static files:
#
# location / {
#     limit_req zone=general_limit burst=50;
#     proxy_pass http://127.0.0.1:3000;
#     ...
# }

# 6. Test config: sudo nginx -t
# 7. Reload nginx: sudo systemctl reload nginx
